---
layout: page
title: æ–‡æ¡£æ¼”ç¤º
description: åŒ»é™¢å¤„æ–¹å•æ¼”ç¤ºé¡µé¢ï¼Œå±•ç¤ºäº†ä½¿ç”¨ HTML/CSS æ„å»ºçš„å¤„æ–¹å•æ¨¡æ¿ï¼ŒåŒ…å«å¯ç¼–è¾‘å­—æ®µã€åŠ¨æ€æ¡ç ç”Ÿæˆã€å¯æ‹–æ‹½å°ç« å’Œç­¾åç­‰åŠŸèƒ½ã€‚æ­¤é¡µé¢ä»…ç”¨äºå­¦ä¹ å’Œæ¼”ç¤ºç›®çš„ï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ã€‚
date: 2025-12-22
updated: 2026-01-27
comments: false
---
<!--
License: MIT + è‡ªå®šä¹‰éå•†ç”¨é™„åŠ æ¡æ¬¾ï¼ˆNC Addendumï¼‰

[MIT åŸºç¡€è®¸å¯]
æœ¬æ–‡ä»¶ä»£ç éƒ¨åˆ†æŒ‰ MIT License æˆæƒï¼ˆå…è®¸ä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€åˆå¹¶ã€å‘å¸ƒã€åˆ†å‘ã€å†è®¸å¯ï¼‰ã€‚

[éå•†ç”¨é™„åŠ æ¡æ¬¾ï¼ˆä¼˜å…ˆçº¦æŸï¼‰]
1) ç¦æ­¢å°†æœ¬é¡¹ç›®åŠå…¶è¡ç”Ÿä½œå“ç”¨äºä»»ä½•ç›´æ¥æˆ–é—´æ¥å•†ä¸šç”¨é€”ã€‚
2) æœ¬é™„åŠ æ¡æ¬¾å…·æœ‰ä¼ æŸ“æ€§ï¼šåŸºäºæœ¬é¡¹ç›®ç”Ÿæˆã€æ”¹ç¼–ã€å†åˆ†å‘çš„æ–‡ä»¶/æ¨¡æ¿/å¯¼å‡ºç‰©ï¼ˆåŒ…æ‹¬ä»»ä½•äº§å‡ºæ–‡ä»¶ï¼‰ï¼Œå¿…é¡»ç»§ç»­ä¿ç•™æœ¬â€œéå•†ç”¨é™„åŠ æ¡æ¬¾â€ã€‚
3) å†åˆ†å‘æ—¶é¡»ä¿ç•™æœ¬è®¸å¯è¯å£°æ˜ä¸å…è´£å£°æ˜ã€‚

å…è´£å£°æ˜ï¼š
æœ¬é¡µé¢ä»…ç”¨äºå­¦ä¹ ä¸æ’ç‰ˆæ¼”ç¤ºï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ï¼Œä¸å¾—ç”¨äºçœŸå®è¯Šç–—ã€çœŸå®å¤„æ–¹å¼€å…·æˆ–ä»»ä½•è¿æ³•ç”¨é€”ã€‚
-->

<style id="pageStyle">
  @page {
    size: A5 landscape;
    margin: 0;
  }
</style>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Liu+Jian+Mao+Cao&family=Zhi+Mang+Xing&display=swap');

  #pgFinalRoot {
    --pg-panel-bg: rgba(255, 255, 255, 0);
    --pg-panel-border: rgba(0, 0, 0, 0.1);
  }

  #pgFinalRoot * {
    box-sizing: border-box;
  }

  #pgFinalRoot .warning-box {
    padding: 1rem;
    margin-bottom: 1rem;
    background: rgba(220, 53, 69, 0.1);
    border-left: 4px solid #dc3545;
    border-radius: 8px;
    color: var(--text-p0);
  }

  #pgFinalRoot .pg-wrap {
    background: var(--card);
    border: 1px solid var(--block-border);
    border-radius: 16px;
    padding: 1rem;
  }

  #pgFinalRoot .pg-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    align-items: start;
  }

  #pgFinalRoot .paper-shell {
    background: var(--block);
    border: 1px solid var(--block-border);
    border-radius: 12px;
    padding: 1rem;
    overflow: auto;
    min-height: 640px;
  }

  #pgFinalRoot .canvas-wrapper {
    width: 100%;
    min-height: 580px;
    display: block;
    overflow: auto;
    cursor: grab;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0));
  }

  #pgFinalRoot .canvas-wrapper.is-panning {
    cursor: grabbing;
  }

  #pgFinalRoot .paper-stage {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    width: max-content;
    min-width: 100%;
    margin: 0 auto;
    padding: 2px;
  }

  #pgFinalRoot .paper {
    box-sizing: border-box;
    position: relative;
    background: #fff;
    color: #000;
    width: 210mm;
    height: 148mm;
    padding: 2px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    font-family: "SimSun", "Songti SC", serif;
    user-select: none;
    overflow: hidden;
  }

  #pgFinalRoot .controls {
    position: relative;
    top: 0;
    background: var(--pg-panel-bg);
    border: 1px solid var(--pg-panel-border);
    border-radius: 16px;
    padding: 16px;
    max-height: none;
    overflow-y: visible;
    backdrop-filter: blur(16px);
  }

  #pgFinalRoot .controls-header {
    margin: 0;
    padding-bottom: 10px;
    margin-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 16px;
    color: var(--text-p0);
    text-align: center;
  }

  #pgFinalRoot .control-group {
    margin-bottom: 12px;
  }

  #pgFinalRoot .control-group label {
    display: block;
    margin-bottom: 6px;
    color: var(--text-p1);
    font-size: 12px;
    font-weight: 600;
  }

  #pgFinalRoot .control-group input[type="text"],
  #pgFinalRoot .control-group select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--block-border);
    background: var(--card);
    color: var(--text-p0);
    outline: none;
  }

  #pgFinalRoot .control-group input[type="color"] {
    width: 100%;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--block-border);
    background: var(--card);
    padding: 2px;
  }

  #pgFinalRoot .control-group input[type="range"] {
    width: 100%;
  }

  #pgFinalRoot .btn {
    width: 100%;
    border: none;
    border-radius: 10px;
    padding: 10px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    background: #0071e3;
  }

  #pgFinalRoot .btn-green {
    background: #34c759;
  }

  #pgFinalRoot .btn-black {
    background: #1d1d1f;
  }

  #pgFinalRoot .btn-red {
    background: #ff3b30;
    font-size: 12px;
    padding: 8px;
  }

  #pgFinalRoot .section-title {
    font-size: 11px;
    color: var(--text-p2);
    margin: 16px 0 8px;
    font-weight: 700;
    border-left: 3px solid #0071e3;
    padding-left: 6px;
  }

  #pgFinalRoot .hidden {
    display: none !important;
  }

  #pgFinalRoot .barcode-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    z-index: 20;
    background: #fff;
    padding: 2px;
    border: 1px dashed transparent;
    transition: border 0.2s;
  }

  #pgFinalRoot .barcode-wrapper:hover {
    border-color: #ccc;
  }

  #pgFinalRoot .barcode-bars {
    display: flex;
    align-items: flex-start;
    height: 30px;
  }

  #pgFinalRoot #diagBarcodeBars {
    height: 75px;
    justify-content: flex-end;
  }

  #pgFinalRoot .bar {
    background: #000;
    display: inline-block;
    height: 100%;
  }

  #pgFinalRoot .difang-box {
    border: 1px solid #000;
    padding: 2px 10px;
    font-size: 16px;
    letter-spacing: 5px;
    cursor: pointer;
    user-select: none;
  }

  #pgFinalRoot .hospital-input {
    font-size: 24px;
    border: none;
    outline: none;
    text-align: center;
    width: 350px;
    font-family: inherit;
    background: transparent;
  }

  #pgFinalRoot #layout-diagnosis {
    display: none;
    flex-direction: column;
    width: 100%;
    height: 100%;
    padding: 10mm 15mm;
  }

  #pgFinalRoot .diag-header-area {
    position: relative;
    margin-bottom: 25px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #pgFinalRoot .diag-barcode {
    position: absolute;
    right: 0;
    top: 0;
    cursor: pointer;
  }

  #pgFinalRoot .diag-hosp-name {
    font-size: 34px;
    font-weight: bold;
    letter-spacing: 2px;
    margin-top: 10px;
    border: none;
    outline: none;
    background: transparent;
    text-align: center;
    width: 100%;
    font-family: inherit;
  }

  #pgFinalRoot .diag-title-wrapper {
    width: 100%;
    border-bottom: 2px solid #000;
    margin-top: 10px;
    padding-bottom: 5px;
    text-align: center;
  }

  #pgFinalRoot .diag-title-name {
    font-size: 32px;
    font-weight: bold;
    letter-spacing: 20px;
    padding-left: 20px;
    display: inline-block;
  }

  #pgFinalRoot .diag-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    font-size: 16px;
    margin-top: 5px;
    margin-bottom: 10px;
    line-height: 1.8;
  }

  #pgFinalRoot .diag-info-grid.two-cols {
    grid-template-columns: 1fr 1fr;
    margin-bottom: 15px;
  }

  #pgFinalRoot .diag-editable {
    outline: none;
    border: none;
    border-bottom: 1px solid transparent;
    min-width: 40px;
    background: transparent;
  }

  #pgFinalRoot .diag-text-block {
    font-size: 16px;
    line-height: 2;
    margin-bottom: 15px;
    text-align: justify;
  }

  #pgFinalRoot .diag-text-block.flex-grow {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    margin-bottom: 5px;
  }

  #pgFinalRoot .diag-textarea {
    width: 100%;
    border: none;
    outline: none;
    resize: none;
    background: transparent;
    font-family: inherit;
    font-size: 16px;
    line-height: 2;
    overflow: hidden;
  }

  #pgFinalRoot .diag-bottom-wrapper {
    margin-top: auto;
  }

  #pgFinalRoot .diag-footer-area {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    font-size: 16px;
    line-height: 1.8;
    border-bottom: 2px solid #000;
    padding-bottom: 5px;
    margin-bottom: 5px;
  }

  #pgFinalRoot .invalid-note {
    text-align: right;
    font-size: 15px;
  }

  #pgFinalRoot .draggable-item {
    position: absolute;
    top: 0;
    left: 0;
    cursor: move;
    touch-action: none;
    z-index: 100;
    user-select: none;
    mix-blend-mode: multiply;
    transform-origin: center center;
    border: 1px solid transparent;
  }

  #pgFinalRoot .draggable-item.is-selected {
    outline: 2px dashed #007bff;
    outline-offset: 2px;
    z-index: 101;
  }

  #pgFinalRoot .draggable-sign-container {
    background: rgba(0, 0, 0, 0.01);
    padding: 5px;
    border-radius: 4px;
  }

  #pgFinalRoot .doctor-signature {
    font-family: 'Liu Jian Mao Cao', cursive;
    color: #1a2233;
    white-space: nowrap;
    pointer-events: none;
    filter: blur(0.4px);
  }

  @media (max-width: 1220px) {
    #pgFinalRoot .pg-layout {
      grid-template-columns: 1fr;
    }
  }

  @media print {

    html,
    body {
      margin: 0 !important;
      padding: 0 !important;
      background: #fff !important;
      overflow: visible !important;
    }

    body * {
      visibility: hidden !important;
    }

    #pgFinalRoot,
    #pgFinalRoot .pg-wrap,
    #pgFinalRoot .pg-layout,
    #pgFinalRoot .paper-shell,
    #pgFinalRoot .canvas-wrapper,
    #pgFinalRoot .paper-stage {
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
      min-height: 0 !important;
      overflow: visible !important;
    }

    #pgFinalRoot #paperArea,
    #pgFinalRoot #paperArea * {
      visibility: visible !important;
    }

    #pgFinalRoot #paperArea {
      position: fixed !important;
      inset: 0 !important;
      box-shadow: none !important;
      margin: auto !important;
      border-radius: 0 !important;
      width: 210mm !important;
      padding: 0 !important;
      transform: none !important;
    }

    #pgFinalRoot .controls,
    #pgFinalRoot .warning-box {
      display: none !important;
    }

    #pgFinalRoot .draggable-item {
      outline: none !important;
      border: none !important;
      cursor: default;
      mix-blend-mode: normal !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }
</style>

<div id="pgFinalRoot">
  <div class="warning-box">
    âš ï¸ å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ä»…ç”¨äºå­¦ä¹ ä¸æ’ç‰ˆæ¼”ç¤ºï¼Œä¸æ„æˆåŒ»ç–—å»ºè®®ï¼Œä¸å¾—ç”¨äºçœŸå®è¯Šç–—æˆ–è¿æ³•ç”¨é€”ã€‚ğŸ§¾ è®¸å¯ï¼šMIT + éå•†ç”¨é™„åŠ æ¡æ¬¾ï¼ˆè¡ç”Ÿ/ç”Ÿæˆæ–‡ä»¶é¡»ç»§æ‰¿è¯¥æ¡æ¬¾ï¼‰ã€‚
  </div>
  <div class="pg-wrap">
    <div class="pg-layout">
      <div class="paper-shell">
        <div style="margin-bottom:0.75rem;color:var(--text-p1);font-size:0.95rem;">ğŸ§¾ å¤„æ–¹ç¼–è¾‘åŒºï¼ˆå¯æ‹–æ‹½å°ç« /ç­¾åï¼Œç‚¹å‡»æ¡ç å¯éšæœºæ¢å·ï¼‰</div>
        <div class="canvas-wrapper" id="canvasWrapper">
          <div class="paper-stage" id="paperStage">
            <div class="paper" id="paperArea">
              <div id="layout-prescription"
                style="display:flex;flex-direction:column;width:100%;height:100%;padding:0 20px 0 10px;box-sizing:border-box;">
                <div
                  style="display:flex;justify-content:space-between;align-items:flex-start;margin-top:0;height:40px;">
                  <div class="barcode-wrapper" onclick="App.refreshAllRandom()" title="ç‚¹å‡»åˆ·æ–°" style="margin-left:10px;">
                    <div class="barcode-bars" id="a5BarcodeBars"></div>
                  </div>
                  <div class="difang-box" id="difangBox" onclick="App.toggleDifang()" title="ç‚¹å‡»åˆ‡æ¢å¤„æ–¹ç±»å‹">åº• æ–¹</div>
                </div>

                <div style="text-align:center;position:relative;margin-bottom:10px;">
                  <input class="hospital-input" id="headerHospitalNameA5" value="XXXä¸­å¿ƒåŒ»é™¢"
                    oninput="App.syncHospitalName('a5')">
                  <div
                    style="position:absolute;right:80px;top:0;font-size:22px;letter-spacing:2px;font-family:inherit;">
                    å¤„æ–¹ç¬º</div>
                </div>

                <div style="display:flex;justify-content:center;gap:40px;font-size:13px;margin-bottom:5px;">
                  <div style="display:flex;flex-direction:column;align-items:flex-end;line-height:1.6;">
                    <div>å®šç‚¹åŒ»ç–—æœºæ„ç¼–ç ï¼š<input id="medCodeInput" value="08110004"
                        style="border:none;background:transparent;outline:none;width:70px;font-family:inherit;font-size:13px;">
                    </div>
                    <div>å¤„æ–¹å·ï¼š<input id="prescNumInput" value="66942"
                        style="border:none;background:transparent;outline:none;width:90px;font-family:inherit;font-size:13px;">
                    </div>
                    <div>è¯æˆ¿ï¼š<input value="é—¨è¯Šè¯æˆ¿"
                        style="border:none;background:transparent;outline:none;width:70px;font-family:inherit;font-size:13px;">
                    </div>
                  </div>
                  <div style="display:flex;flex-direction:column;align-items:flex-start;line-height:1.6;">
                    <div>å°±è¯Šç±»å‹ï¼š<input value="é—¨è¯Š"
                        style="border:none;background:transparent;outline:none;width:50px;font-family:inherit;font-size:13px;">
                    </div>
                    <div>è´¹åˆ«ï¼š<input value="è‡ªè´¹"
                        style="border:none;background:transparent;outline:none;width:50px;font-family:inherit;font-size:13px;">
                    </div>
                    <div>èº«ä»½ï¼š<input value="ä¸€èˆ¬äººå‘˜"
                        style="border:none;background:transparent;outline:none;width:60px;font-family:inherit;font-size:13px;">
                    </div>
                  </div>
                </div>

                <div style="display:flex;align-items:center;font-size:14px;margin-bottom:2px;padding:0 5px;">
                  <div style="width:140px;">ç§‘å®¤ï¼š<input value="ç¥ç»å†…ç§‘"
                      style="border:none;background:transparent;outline:none;width:80px;font-family:inherit;font-size:14px;">
                  </div>
                  <div style="flex-grow:1;display:flex;justify-content:space-between;">
                    <div>å§“åï¼š<input value="XXX"
                        style="border:none;background:transparent;outline:none;width:60px;font-family:inherit;font-size:14px;">
                    </div>
                    <div>æ€§åˆ«ï¼š<input value="XX"
                        style="border:none;background:transparent;outline:none;width:20px;font-family:inherit;font-size:14px;">
                    </div>
                    <div>å¹´é¾„ï¼š<input value="XX"
                        style="border:none;background:transparent;outline:none;width:20px;font-family:inherit;font-size:14px;">å²
                    </div>
                    <div>å•ä½ï¼š<input value=""
                        style="border:none;background:transparent;outline:none;width:60px;font-family:inherit;font-size:14px;">
                    </div>
                  </div>
                </div>

                <div style="border:1px solid #000;display:flex;flex-grow:1;position:relative;margin-top:2px;">
                  <div style="width:160px;border-right:1px solid #000;display:flex;flex-direction:column;">
                    <div style="padding:5px;flex-grow:1;font-size:14px;">
                      <div style="margin-bottom:5px;">è¯Šæ–­ï¼š</div>
                      <textarea id="a5Diag" oninput="App.syncContent('diag', this)"
                        style="width:100%;height:75%;border:none;outline:none;resize:none;font-family:inherit;background:transparent;font-size:14px;">é‡åº¦æŠ‘éƒå‘ä½œï¼ˆä¸ä¼´ç²¾ç¥ç—…æ€§ç—‡çŠ¶ï¼‰F32.2 å¹¿æ³›æ€§ç„¦è™‘éšœç¢ï¼ˆå…±ç—…ï¼‰F41.1</textarea>
                    </div>
                    <div style="border-top:1px solid #000;padding:5px;font-size:13px;line-height:1.4;">
                      è¯´æ˜:è¯å“åç§°å‰æ ‡<br>æ³¨æœ‰<span style="border-bottom:1px solid #000;">â–²è¡¨ç¤ºéœ€çš®è¯•<br>è¯å“ã€‚</span></div>
                  </div>

                  <div style="flex-grow:1;padding:5px 15px;display:flex;flex-direction:column;position:relative;">
                    <div style="font-family:'Times New Roman', serif;font-size:56px;line-height:.9;margin-bottom:5px;">
                      <span style="position:relative;display:inline-block;">P<span
                          style="position:absolute;right:0;bottom:.08em;font-size:.6em;">x</span></span>
                    </div>
                    <textarea id="a5Rx" oninput="App.syncContent('rx', this)"
                      style="width:100%;flex-grow:1;border:none;outline:none;resize:none;font-family:inherit;font-size:14px;line-height:1.8;background:transparent;padding-left:5px;">1. è‰é…¸è‰¾å¸è¥¿é…æ™®å…°ç‰‡(10mg/ç‰‡) 50ç‰‡/20mg Qd å£æœ
2. æ™®ç‘å·´æ—èƒ¶å›Šï¼ˆ150mg/ç²’ï¼‰32ç²’/150mg Qd å£æœ</textarea>

                    <div
                      style="display:flex;justify-content:space-between;align-items:flex-end;font-size:14px;margin-top:5px;padding-bottom:5px;">
                      <div style="display:flex;align-items:flex-end;"><span>åŒ»å¸ˆç­¾å­—ï¼š</span>
                        <div style="width:120px;border-bottom:1px solid #000;"></div>
                      </div>
                      <div><input id="dateInput"
                          style="border:none;background:transparent;width:130px;outline:none;font-family:inherit;text-align:right;">
                      </div>
                    </div>
                  </div>
                </div>

                <div style="display:flex;justify-content:space-between;font-size:14px;margin-top:4px;padding:0 10px;">
                  <div>å®¡æ ¸</div>
                  <div>è°ƒé…</div>
                  <div>æ ¸å¯¹</div>
                  <div>å‘è¯</div>
                </div>
              </div>

              <div id="layout-diagnosis">
                <div class="diag-header-area">
                  <div class="diag-barcode" onclick="App.refreshAllRandom()" title="ç‚¹å‡»åˆ·æ–°">
                    <div class="barcode-bars" id="diagBarcodeBars"></div>
                  </div>
                  <div style="padding-top:15px;width:100%;text-align:center;">
                    <input class="diag-hosp-name" id="diagHospitalName" value="XXXä¸­å¿ƒåŒ»é™¢"
                      oninput="App.syncHospitalName('diag')">
                    <div class="diag-title-wrapper">
                      <div class="diag-title-name">è¯Šæ–­è¯æ˜</div>
                    </div>
                  </div>
                </div>

                <div class="diag-info-grid">
                  <div>å§“åï¼š<span class="diag-editable" contenteditable>XXX</span></div>
                  <div style="text-align:center;">æ€§åˆ«ï¼š<span class="diag-editable" contenteditable>XX</span></div>
                  <div style="text-align:right;">å¹´é¾„ï¼š<span class="diag-editable" contenteditable>XXå²</span></div>
                </div>
                <div class="diag-info-grid two-cols">
                  <div>é—¨è¯Šå·ï¼š<span class="diag-editable" id="diagOutpatientNum" contenteditable>MZ142100073</span></div>
                  <div style="text-align:right;">ç§‘å®¤ï¼š<span class="diag-editable" contenteditable>ç²¾ç¥ç§‘</span></div>
                </div>

                <div class="diag-text-block"><span style="font-weight:bold;">ä¸»è¯‰ï¼š</span><span class="diag-editable"
                    contenteditable>æƒ…ç»ªä½è½ã€å…´è¶£ç¼ºä¹ã€ç„¦è™‘ä¸å®‰ã€ç¡çœ éšœç¢1å¹´ä½™ï¼ŒåŠ é‡ä¼´å¿ƒæ…Œã€èƒ¸é—·ã€ä¹åŠ›3ä¸ªæœˆã€‚</span></div>
                <div class="diag-text-block"><span style="font-weight:bold;">ç°ç—…å²ï¼š</span><span class="diag-editable"
                    contenteditable>æ‚£è€…äºçº¦1å¹´å‰æ— æ˜æ˜¾è¯±å› é€æ¸å‡ºç°æƒ…ç»ªä½è½ã€æä¸èµ·å…´è¶£ã€åšä»€ä¹ˆéƒ½è§‰å¾—æ²¡æ„æ€ã€ç²¾åŠ›æ˜æ˜¾ä¸‹é™ã€å¸¸è‡ªè´£ã€æ³¨æ„åŠ›éš¾ä»¥é›†ä¸­ã€è®°å¿†åŠ›ä¸‹é™ã€‚</span></div>
                <div class="diag-text-block"><span style="font-weight:bold;">ä¸´åºŠè¯Šæ–­ï¼š</span><span id="a4Diag"
                    class="diag-editable" contenteditable oninput="App.syncContent('diag', this)">é‡åº¦æŠ‘éƒå‘ä½œï¼ˆä¸ä¼´ç²¾ç¥ç—…æ€§ç—‡çŠ¶ï¼‰F32.2
                    å¹¿æ³›æ€§ç„¦è™‘éšœç¢ï¼ˆå…±ç—…ï¼‰F41.1</span></div>

                <div class="diag-text-block flex-grow">
                  <span style="font-weight:bold;">å¤„ç†æ„è§ï¼š</span>
                  <textarea id="a4Rx" class="diag-textarea" oninput="App.syncContent('rx', this)">1. è‰é…¸è‰¾å¸è¥¿é…æ™®å…°ç‰‡(10mg/ç‰‡) 50ç‰‡/20mg Qd å£æœã€‚
2. æ™®ç‘å·´æ—èƒ¶å›Šï¼ˆ150mg/ç²’ï¼‰32ç²’/150mg Qd å£æœ</textarea>
                  <textarea class="diag-textarea" style="padding-top:5px;" placeholder="å…¶ä»–éè¯ç‰©åŒ»å˜±ï¼ˆä¸åŒæ­¥åˆ°å¤„æ–¹ï¼‰...">3. è‹¥å‡ºç°ä¸¥é‡è‡ªæ€è§‚å¿µã€æ¿€è¶Šã€å¤±çœ åŠ é‡ç­‰ï¼Œç«‹å³å°±è¯Šæˆ–æ€¥è¯Šã€‚
4. æŒ‰æ—¶æœè¯ï¼Œä¸å¯æ“…è‡ªåœè¯æˆ–éª¤åœ</textarea>
                </div>

                <div class="diag-bottom-wrapper">
                  <div class="diag-footer-area">
                    <div>
                      <div>å¼€å…·æ—¥æœŸï¼š<span class="diag-editable" id="diagDate1" contenteditable>2026-2-11 08:21:24</span>
                      </div>
                      <div style="margin-top:8px;">æ‰“å°æ—¥æœŸï¼š<span class="diag-editable" id="diagDate2"
                          contenteditable>2026-2-11 09:39:47</span></div>
                    </div>
                    <div style="display:flex;align-items:baseline;position:relative;"><span>ä¸»æ²»åŒ»å¸ˆï¼š</span>
                      <div style="width:140px;border-bottom:1px solid transparent;"></div>
                    </div>
                  </div>
                  <div class="invalid-note">(æ­¤è¯æ˜æ— åŒ»é™¢ä¸“ç”¨ç« æ— æ•ˆ)</div>
                </div>
              </div>

              <div id="dynamicElementsContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls" id="draggableControls">
        <h3 class="controls-header"><span style="margin-right: 6px;">ğŸ› ï¸</span> æ§åˆ¶é¢æ¿</h3>
        <div class="control-group"><button class="btn btn-black" id="modeToggleBtn" onclick="App.toggleMode()"
            style="margin-top:0;">ğŸ”€ åˆ‡æ¢ä¸ºï¼šA4 è¯Šæ–­è¯æ˜</button></div>
        <div class="control-group">
          <div class="section-title" style="margin-top:0;">ğŸ–ï¸ ç”»å¸ƒæ»šåŠ¨</div>
          <div style="margin-top:8px;font-size:12px;color:var(--text-p2);">æç¤ºï¼šæ‹–åŠ¨ç”»å¸ƒç©ºç™½åŒºåŸŸå¯æ»šåŠ¨ï¼Œæˆ–ä½¿ç”¨æ»šåŠ¨æ¡æŸ¥çœ‹é¡µé¢ã€‚</div>
        </div>
        <div id="noSelectionMsg" style="color:var(--text-p2); text-align:center; padding:10px 0; font-weight:500;">ğŸ‘†
          ç‚¹å‡»ç”»å¸ƒä¸Šçš„å°ç« æˆ–ç­¾å<br>å³å¯è¿›è¡Œå•ç‹¬è®¾ç½®</div>

        <div id="circleEditArea" class="hidden">
          <div class="section-title" style="border-left-color:#ff3b30;">ğŸ”´ åŒ»é™¢å…¬ç« è®¾ç½®</div>
          <div class="control-group">
            <label>åŒ»é™¢åç§°ï¼ˆåŒæ­¥ï¼‰</label><input type="text" id="sealTopText" oninput="App.syncHospitalName('control')">
            <label style="margin-top:8px;">ä¸‹éƒ¨æ–‡å­—</label><input type="text" id="sealBottomText" value="å¤„æ–¹ä¸“ç”¨ç« "
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">æ—‹è½¬è§’åº¦</label><input type="range" id="circleRotate" min="-180" max="180"
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">ç£¨æŸç¨‹åº¦</label><input type="range" id="circleGrunge" min="0" max="100"
              oninput="App.updateActiveElement()">
          </div>
        </div>

        <div id="rectEditArea" class="hidden">
          <div class="section-title">ğŸŸ¦ æ–¹å½¢å°ç« è®¾ç½®</div>
          <div class="control-group">
            <label>ç¬¬ä¸€è¡Œå†…å®¹</label><input type="text" id="activeSealText" oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">ç¬¬äºŒè¡Œï¼ˆé€‰å¡«ï¼‰</label><input type="text" id="activeSealText2"
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">æ—‹è½¬è§’åº¦</label><input type="range" id="activeSealRotate" min="-180" max="180"
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">ç£¨æŸç¨‹åº¦</label><input type="range" id="activeSealGrunge" min="0" max="100"
              oninput="App.updateActiveElement()">
            <button class="btn btn-red" onclick="App.deleteActiveElement()">ğŸ—‘ï¸ åˆ é™¤æ­¤ç« </button>
          </div>
        </div>

        <div id="signEditArea" class="hidden">
          <div class="section-title" style="border-left-color:#34c759;">âœï¸ åŒ»ç”Ÿç­¾åè®¾ç½®</div>
          <div class="control-group">
            <label>ç­¾åå†…å®¹</label><input type="text" id="signText" oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">ç­¾åå­—ä½“</label>
            <select id="signFont" onchange="App.updateActiveElement()">
              <option value="'Liu Jian Mao Cao', cursive">ç‹‚è‰ (åˆ˜å»ºæ¯›è‰)</option>
              <option value="'Zhi Mang Xing', cursive">è¡Œè‰ (å¿—è½è¡Œä¹¦)</option>
            </select>
            <label style="margin-top:8px;">ç‹¬ç«‹æ—‹è½¬</label><input type="range" id="signRotate" min="-180" max="180"
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">å­—ä½“å¤§å°</label><input type="range" id="signSize" min="20" max="120" value="50"
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">å­—é—´è·</label><input type="range" id="signSpace" min="-30" max="10" value="-8"
              oninput="App.updateActiveElement()">
            <label style="margin-top:8px;">å­—ä½“å€¾æ–œ</label><input type="range" id="signSkew" min="-50" max="20" value="-25"
              oninput="App.updateActiveElement()">
            <div style="margin-top:8px;"><label>å¢¨æ°´é¢œè‰²</label><input type="color" id="signColor" value="#1a2233"
                oninput="App.updateActiveElement()"></div>
            <button class="btn btn-red" onclick="App.deleteActiveElement()">ğŸ—‘ï¸ åˆ é™¤æ­¤ç­¾å</button>
          </div>
        </div>

        <div class="section-title">âœ¨ æ·»åŠ å…ƒç´ ä¸å…¨å±€</div>
        <div class="control-group" style="display:flex;gap:10px;">
          <button class="btn btn-green" style="margin:0;font-size:12px;" onclick="App.addRectSeal('å·²å‘è¯')">â• åŠ æ–¹ç« </button>
          <button class="btn" style="margin:0;font-size:12px;background:#5856d6;" onclick="App.addSignature('ç‹åŒ»ç”Ÿ')">â•
            åŠ ç­¾å</button>
        </div>
        <div class="control-group"><label>å…¨å±€å°ç« é¢œè‰²</label><input type="color" id="globalSealColor" value="#d90000"
            oninput="App.updateGlobalSealColor()"></div>
        <div class="control-group">
          <button class="btn" style="background:#1d1d1f;margin-top:0;" onclick="App.refreshAllRandom()">ğŸ”„ åˆ·æ–°å•å·</button>
          <button class="btn" id="aiBtn" style="background:#8a2be2;margin-top:10px;"
            onclick="App.generateAIPrescription()">âœ¨ AI æ™ºèƒ½ç”Ÿæˆå¤„æ–¹</button>
        </div>
        <button class="btn" onclick="App.printDocument()">ğŸ–¨ï¸ æ‰“å°å¤„æ–¹</button>
      </div>
    </div>
  </div>
</div>

<script>
  const App = (function () {
    let state = {
      mode: 'prescription',
      elementCount: 0,
      activeId: null,
      elements: {}
    };
    const difangTypes = ['åº• æ–¹', 'ç²¾ ä¸€', 'ç²¾ äºŒ', 'éº» é†‰'];
    let currentDifangIdx = 0;
    let drag = { isDragging: false, startX: 0, startY: 0, initX: 0, initY: 0 };
    let canvasPan = { isPanning: false, startX: 0, startY: 0, scrollLeft: 0, scrollTop: 0 };
    const DOM = {
      canvas: document.getElementById('canvasWrapper'),
      stage: document.getElementById('paperStage'),
      paper: document.getElementById('paperArea'),
      container: document.getElementById('dynamicElementsContainer')
    };

    function toggleDifang() {
      currentDifangIdx = (currentDifangIdx + 1) % difangTypes.length;
      const el = document.getElementById('difangBox');
      if (el) el.innerText = difangTypes[currentDifangIdx];
    }

    function generateNoiseElements(w, h) {
      const count = (w * h) / 10;
      let elements = '<g>';
      for (let i = 0; i < count; i++) {
        elements += `<circle cx="${Math.random() * w}" cy="${Math.random() * h}" r="${Math.random() * 1.5}" fill="black" />`;
      }
      return elements + '</g>';
    }

    function buildCircleSealSVG(id, text1, text2, grunge) {
      const sealFont = "'å®‹ä½“','SimSun','Songti SC','STSong',serif";
      return `
      <svg class="seal-svg" viewBox="0 0 170 170" style="overflow:visible;">
        <defs>
          <path id="path_${id}" d="M 35,112 A 56,56 0 1,1 135,112" />
          <mask id="mask_${id}"><rect width="100%" height="100%" fill="white" /><g opacity="${grunge / 100}">${generateNoiseElements(170, 170)}</g></mask>
        </defs>
        <g mask="url(#mask_${id})" fill="currentColor" stroke="currentColor">
          <circle cx="85" cy="85" r="78" fill="none" stroke-width="5" />
          <polygon points="85,60 90.6,77.3 108.8,77.3 94.1,88 99.7,105.3 85,94.6 70.3,105.3 75.9,88 61.2,77.3 79.4,77.3" stroke="none" />
          <text font-family="${sealFont}" font-weight="bold" font-size="24" letter-spacing="1" text-anchor="middle" stroke="none">
            <textPath xlink:href="#path_${id}" startOffset="50%">${text1}</textPath>
          </text>
          <text font-family="${sealFont}" font-weight="bold" x="85" y="130" font-size="20" letter-spacing="2" text-anchor="middle" stroke="none">${text2}</text>
        </g>
      </svg>`;
    }

    function buildRectSealSVG(id, text1, text2, grunge) {
      const sealFont = "'å®‹ä½“','SimSun','Songti SC','STSong',serif";
      const texts = text2
        ? `<text x="45" y="17" text-anchor="middle" font-size="16" letter-spacing="1" font-family="${sealFont}" font-weight="bold" stroke="none">${text1}</text>
           <text x="45" y="33" text-anchor="middle" font-size="12" letter-spacing="0" font-family="${sealFont}" font-weight="bold" stroke="none">${text2}</text>`
        : `<text x="45" y="26" text-anchor="middle" font-size="20" letter-spacing="1" font-family="${sealFont}" font-weight="bold" stroke="none">${text1}</text>`;
      return `
      <svg class="seal-svg" viewBox="0 0 90 40" style="overflow:visible;">
        <defs><mask id="mask_${id}"><rect width="100%" height="100%" fill="white" /><g opacity="${grunge / 100}">${generateNoiseElements(90, 40)}</g></mask></defs>
        <g mask="url(#mask_${id})" fill="currentColor" stroke="currentColor">
          <rect x="2" y="2" width="86" height="36" fill="none" stroke-width="2.5" />
          ${texts}
        </g>
      </svg>`;
    }

    function buildSignatureHTML(data) {
      return `<div class="doctor-signature" style="font-family:${data.font};font-size:${data.size}px;letter-spacing:${data.spacing}px;transform:skewX(${data.skew}deg);filter:${data.font.includes('Liu Jian Mao Cao') && data.skew < -10 ? 'blur(0.4px)' : 'none'};">${data.text1}</div>`;
    }

    function addDraggableElement(type, data) {
      state.elementCount++;
      const id = data.id || `el_${state.elementCount}`;
      const wrapper = document.createElement('div');
      wrapper.className = 'draggable-item';
      if (type === 'sign') wrapper.classList.add('draggable-sign-container');
      wrapper.id = id;

      const paperWidth = state.mode === 'diagnosis' ? 794 : 800;
      const paperHeight = state.mode === 'diagnosis' ? 1123 : 560;
      const posX = data.x !== undefined ? data.x : (paperWidth / 2 - 50 + (Math.random() * 100 - 50));
      const posY = data.y !== undefined ? data.y : (paperHeight / 2 - 50 + (Math.random() * 100 - 50));

      wrapper.setAttribute('data-type', type);
      wrapper.setAttribute('data-color', data.color || '#d90000');
      wrapper.setAttribute('data-grunge', data.grunge || 30);
      state.elements[id] = { x: posX, y: posY, r: data.rotate || 0 };
      wrapper.style.transform = `translate(${posX}px, ${posY}px) rotate(${data.rotate || 0}deg)`;
      wrapper.style.color = data.color || '#d90000';

      if (type === 'circle') {
        wrapper.setAttribute('data-text1', data.text1 || 'XXå¸‚ä¸­å¿ƒåŒ»é™¢');
        wrapper.setAttribute('data-text2', data.text2 || 'å¤„æ–¹ä¸“ç”¨ç« ');
        wrapper.innerHTML = buildCircleSealSVG(id, data.text1, data.text2, data.grunge || 30);
        wrapper.style.width = '170px';
        wrapper.style.height = '170px';
      } else if (type === 'rect') {
        wrapper.setAttribute('data-text1', data.text1 || 'å·²å‘è¯');
        wrapper.setAttribute('data-text2', data.text2 || '');
        wrapper.innerHTML = buildRectSealSVG(id, data.text1, data.text2, data.grunge || 30);
        wrapper.style.width = '90px';
        wrapper.style.height = '40px';
      } else if (type === 'sign') {
        wrapper.setAttribute('data-text1', data.text1 || 'XXX');
        wrapper.setAttribute('data-font', data.font || "'Liu Jian Mao Cao', cursive");
        wrapper.setAttribute('data-size', data.size || 50);
        wrapper.setAttribute('data-spacing', data.spacing || -8);
        wrapper.setAttribute('data-skew', data.skew || -25);
        wrapper.style.color = data.color || '#1a2233';
        wrapper.innerHTML = buildSignatureHTML(data);
      }

      DOM.container.appendChild(wrapper);
      selectElement(wrapper);
      return wrapper;
    }

    function updateElementTransform(elId) {
      const el = document.getElementById(elId);
      const elState = state.elements[elId];
      if (el && elState) el.style.transform = `translate(${elState.x}px, ${elState.y}px) rotate(${elState.r}deg)`;
    }

    function selectElement(el) {
      if (state.activeId) {
        const prev = document.getElementById(state.activeId);
        if (prev) prev.classList.remove('is-selected');
      }
      state.activeId = el ? el.id : null;
      if (el) el.classList.add('is-selected');

      document.getElementById('noSelectionMsg').classList.add('hidden');
      document.getElementById('circleEditArea').classList.add('hidden');
      document.getElementById('rectEditArea').classList.add('hidden');
      document.getElementById('signEditArea').classList.add('hidden');

      if (!el) {
        document.getElementById('noSelectionMsg').classList.remove('hidden');
        return;
      }

      const type = el.getAttribute('data-type');
      const elState = state.elements[el.id] || {};
      if (type === 'circle') {
        document.getElementById('circleEditArea').classList.remove('hidden');
        document.getElementById('sealTopText').value = el.getAttribute('data-text1') || '';
        document.getElementById('sealBottomText').value = el.getAttribute('data-text2') || '';
        document.getElementById('circleRotate').value = elState.r || 0;
        document.getElementById('circleGrunge').value = el.getAttribute('data-grunge') || '30';
      } else if (type === 'rect') {
        document.getElementById('rectEditArea').classList.remove('hidden');
        document.getElementById('activeSealText').value = el.getAttribute('data-text1') || '';
        document.getElementById('activeSealText2').value = el.getAttribute('data-text2') || '';
        document.getElementById('activeSealRotate').value = elState.r || 0;
        document.getElementById('activeSealGrunge').value = el.getAttribute('data-grunge') || '30';
      } else if (type === 'sign') {
        document.getElementById('signEditArea').classList.remove('hidden');
        document.getElementById('signText').value = el.getAttribute('data-text1') || '';
        document.getElementById('signFont').value = el.getAttribute('data-font') || "'Liu Jian Mao Cao', cursive";
        document.getElementById('signRotate').value = elState.r || 0;
        document.getElementById('signSize').value = parseInt(el.getAttribute('data-size')) || 50;
        document.getElementById('signSpace').value = parseInt(el.getAttribute('data-spacing')) || -8;
        document.getElementById('signSkew').value = parseInt(el.getAttribute('data-skew')) || -25;
        document.getElementById('signColor').value = el.getAttribute('data-color') || '#1a2233';
      }
    }

    function updateActiveElement() {
      if (!state.activeId) return;
      const el = document.getElementById(state.activeId);
      if (!el) return;
      const type = el.getAttribute('data-type');

      if (type === 'circle') {
        const t1 = document.getElementById('sealTopText').value;
        const t2 = document.getElementById('sealBottomText').value;
        const rot = document.getElementById('circleRotate').value;
        const grunge = document.getElementById('circleGrunge').value;
        el.setAttribute('data-text1', t1);
        el.setAttribute('data-text2', t2);
        el.setAttribute('data-grunge', grunge);
        state.elements[el.id].r = rot;
        el.innerHTML = buildCircleSealSVG(el.id, t1, t2, grunge);
      } else if (type === 'rect') {
        const t1 = document.getElementById('activeSealText').value;
        const t2 = document.getElementById('activeSealText2').value;
        const rot = document.getElementById('activeSealRotate').value;
        const grunge = document.getElementById('activeSealGrunge').value;
        el.setAttribute('data-text1', t1);
        el.setAttribute('data-text2', t2);
        el.setAttribute('data-grunge', grunge);
        state.elements[el.id].r = rot;
        el.innerHTML = buildRectSealSVG(el.id, t1, t2, grunge);
      } else if (type === 'sign') {
        const text = document.getElementById('signText').value;
        const font = document.getElementById('signFont').value;
        const rotate = document.getElementById('signRotate').value;
        const size = document.getElementById('signSize').value;
        const space = document.getElementById('signSpace').value;
        const skew = document.getElementById('signSkew').value;
        const color = document.getElementById('signColor').value;
        el.setAttribute('data-text1', text);
        el.setAttribute('data-font', font);
        el.setAttribute('data-size', size);
        el.setAttribute('data-spacing', space);
        el.setAttribute('data-skew', skew);
        el.setAttribute('data-color', color);
        el.style.color = color;
        state.elements[el.id].r = rotate;
        el.innerHTML = buildSignatureHTML({ text1: text, font: font, size: size, spacing: space, skew: skew });
      }
      updateElementTransform(el.id);
    }

    function deleteActiveElement() {
      if (!state.activeId) return;
      if (state.activeId === 'sealCircle' || state.activeId === 'dragSign') {
        alert('æ ¸å¿ƒå…¬ç« å’Œç­¾åä¸å¯åˆ é™¤');
        return;
      }
      const el = document.getElementById(state.activeId);
      if (el) el.remove();
      delete state.elements[state.activeId];
      selectElement(null);
    }

    function refreshAllRandom() {
      document.querySelectorAll('#pgFinalRoot .barcode-bars').forEach(container => {
        container.innerHTML = '';
        const isA4 = container.id === 'diagBarcodeBars';
        const barCount = isA4 ? 24 : 35;
        for (let i = 0; i < barCount; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          bar.style.width = (Math.floor(Math.random() * 3) + 1) + 'px';
          bar.style.marginRight = (Math.floor(Math.random() * (isA4 ? 2 : 3)) + 1) + 'px';
          container.appendChild(bar);
        }
      });

      let code = 'H';
      for (let i = 0; i < 11; i++) code += Math.floor(Math.random() * 10);
      const medInput = document.getElementById('medCodeInput');
      if (medInput) medInput.value = code;

      const now = new Date();
      const randomDate = new Date(now.getTime() - (Math.floor(Math.random() * 90) * 24 * 60 * 60 * 1000));
      const y = randomDate.getFullYear();
      const m = String(randomDate.getMonth() + 1).padStart(2, '0');
      const d = String(randomDate.getDate()).padStart(2, '0');
      let rp = '';
      for (let i = 0; i < 5; i++) rp += Math.floor(Math.random() * 10);

      const pNum = document.getElementById('prescNumInput');
      if (pNum) pNum.value = `${y}${m}${d}${rp}`;
      const dInp = document.getElementById('dateInput');
      if (dInp) dInp.value = `${y}-${m}-${d}`;

      const dOut = document.getElementById('diagOutpatientNum');
      if (dOut) dOut.innerText = `MZ${y.toString().slice(-2)}${rp}73`;

      const hs = String(Math.floor(Math.random() * 8) + 8).padStart(2, '0');
      const ms = String(Math.floor(Math.random() * 60)).padStart(2, '0');
      const ss = String(Math.floor(Math.random() * 60)).padStart(2, '0');
      const dD1 = document.getElementById('diagDate1');
      if (dD1) dD1.innerText = `${y}-${parseInt(m)}-${parseInt(d)} ${hs}:${ms}:${ss}`;
      const dD2 = document.getElementById('diagDate2');
      if (dD2) dD2.innerText = `${y}-${parseInt(m)}-${parseInt(d)} ${hs}:${parseInt(ms) + 15}:${ss}`;
    }

    function syncHospitalName(source) {
      const hA5 = document.getElementById('headerHospitalNameA5');
      const hDiag = document.getElementById('diagHospitalName');
      const cSeal = document.getElementById('sealTopText');
      let v = '';
      if ((source === 'a5' || source === 'header') && hA5) v = hA5.value;
      else if (source === 'control' && cSeal) v = cSeal.value;
      else if (source === 'diag' && hDiag) v = hDiag.value;

      if (hA5) hA5.value = v;
      if (hDiag) hDiag.value = v;
      if (cSeal) cSeal.value = v;
      const circle = document.getElementById('sealCircle');
      if (circle) {
        circle.setAttribute('data-text1', v);
        circle.innerHTML = buildCircleSealSVG(circle.id, v, circle.getAttribute('data-text2'), circle.getAttribute('data-grunge'));
      }
    }

    function syncContent(type, sourceEl) {
      const val = sourceEl.tagName === 'SPAN' ? sourceEl.innerText : sourceEl.value;
      if (type === 'diag') {
        const a5 = document.getElementById('a5Diag');
        const a4 = document.getElementById('a4Diag');
        if (a5 && sourceEl !== a5) a5.value = val;
        if (a4 && sourceEl !== a4) a4.innerText = val;
      } else if (type === 'rx') {
        const a5 = document.getElementById('a5Rx');
        const a4 = document.getElementById('a4Rx');
        if (a5 && sourceEl !== a5) a5.value = val;
        if (a4 && sourceEl !== a4) a4.value = val;
      }
      resizeTextareas();
    }

    function resizeTextareas() {
      document.querySelectorAll('#pgFinalRoot .diag-textarea').forEach(el => {
        if (el.offsetParent !== null) {
          el.style.height = 'auto';
          el.style.height = el.scrollHeight + 'px';
        }
      });
    }

    async function generateAIPrescription() {
      const diagText = document.getElementById('a5Diag').value.trim();
      const aiBtn = document.getElementById('aiBtn');
      const rxArea = document.getElementById('a5Rx');
      if (!diagText) {
        rxArea.value = 'è¯·å…ˆè¾“å…¥ä¸´åºŠè¯Šæ–­ã€‚';
        syncContent('rx', rxArea);
        return;
      }

      aiBtn.innerText = 'âœ¨ AI æ€è€ƒä¸­...';
      aiBtn.disabled = true;
      aiBtn.style.opacity = '0.7';

      const endpoint = window.AI_WORKER_ENDPOINT || 'https://deepseek-prescription-proxy.krvyft.workers.dev/api/prescription';
      let data = null;
      const retries = 3;
      const delays = [1000, 2000, 4000];
      let lastError = null;

      try {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ diagText })
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            data = await response.json();
            if (!data || !data.result) throw new Error('ä»£ç†æœåŠ¡è¿”å›ç©ºç»“æœ');
            break;
          } catch (err) {
            lastError = err;
            if (i < retries - 1) await new Promise(r => setTimeout(r, delays[i]));
          }
        }

        if (!data) throw lastError || new Error('æ‰€æœ‰æ¨¡å‹è¯·æ±‚å‡å¤±è´¥');
        rxArea.value = (data.result || '').trim();
        syncContent('rx', rxArea);
      } catch (error) {
        rxArea.value = `ç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
        syncContent('rx', rxArea);
      } finally {
        aiBtn.innerText = 'âœ¨ AI æ™ºèƒ½ç”Ÿæˆå¤„æ–¹';
        aiBtn.disabled = false;
        aiBtn.style.opacity = '1';
      }
    }

    function toggleMode() {
      const pLayout = document.getElementById('layout-prescription');
      const dLayout = document.getElementById('layout-diagnosis');
      const pageStyle = document.getElementById('pageStyle');
      const paper = document.getElementById('paperArea');
      const toggleBtn = document.getElementById('modeToggleBtn');

      if (state.mode === 'prescription') {
        state.mode = 'diagnosis';
        if (pLayout) pLayout.style.display = 'none';
        if (dLayout) dLayout.style.display = 'flex';
        if (pageStyle) pageStyle.innerHTML = '@page { size: A4 portrait; margin: 0; }';
        if (paper) {
          paper.style.width = '210mm';
          paper.style.height = '297mm';
        }
        if (toggleBtn) toggleBtn.innerText = 'ğŸ”€ åˆ‡æ¢ä¸ºï¼šA5 å¤„æ–¹ç¬º';
      } else {
        state.mode = 'prescription';
        if (pLayout) pLayout.style.display = 'flex';
        if (dLayout) dLayout.style.display = 'none';
        if (pageStyle) pageStyle.innerHTML = '@page { size: A5 landscape; margin: 0; }';
        if (paper) {
          paper.style.width = '210mm';
          paper.style.height = '148mm';
        }
        if (toggleBtn) toggleBtn.innerText = 'ğŸ”€ åˆ‡æ¢ä¸ºï¼šA4 è¯Šæ–­è¯æ˜';
      }

      const paperWidth = state.mode === 'diagnosis' ? 794 : 800;
      const paperHeight = state.mode === 'diagnosis' ? 1123 : 560;
      if (state.elements.sealCircle) {
        state.elements.sealCircle.x = state.mode === 'diagnosis' ? (paperWidth / 2 - 85) : (paperWidth - 210);
        state.elements.sealCircle.y = state.mode === 'diagnosis' ? (paperHeight - 180) : (paperHeight - 210);
        updateElementTransform('sealCircle');
      }
      if (state.elements.dragSign) {
        state.elements.dragSign.x = state.mode === 'diagnosis' ? (paperWidth - 220) : (paperWidth - 200);
        state.elements.dragSign.y = state.mode === 'diagnosis' ? (paperHeight - 110) : (paperHeight - 110);
        updateElementTransform('dragSign');
      }
      setTimeout(resizeTextareas, 10);
    }

    function bindEvents() {
      if (DOM.paper) {
        DOM.paper.addEventListener('mousedown', (e) => {
          const el = e.target.closest('.draggable-item');
          if (!el) {
            selectElement(null);
            return;
          }
          selectElement(el);
          const elState = state.elements[el.id];
          if (!elState) return;
          drag.isDragging = true;
          drag.startX = e.clientX;
          drag.startY = e.clientY;
          drag.initX = elState.x;
          drag.initY = elState.y;
          e.stopPropagation();
        });

        DOM.paper.addEventListener('touchstart', (e) => {
          const el = e.target.closest('.draggable-item');
          if (!el) {
            selectElement(null);
            return;
          }
          const touch = e.touches && e.touches[0];
          if (!touch) return;
          selectElement(el);
          const elState = state.elements[el.id];
          if (!elState) return;
          drag.isDragging = true;
          drag.startX = touch.clientX;
          drag.startY = touch.clientY;
          drag.initX = elState.x;
          drag.initY = elState.y;
          e.preventDefault();
          e.stopPropagation();
        }, { passive: false });
      }

      window.addEventListener('mousemove', (e) => {
        if (!drag.isDragging || !state.activeId) return;
        const dx = e.clientX - drag.startX;
        const dy = e.clientY - drag.startY;
        if (state.elements[state.activeId]) {
          state.elements[state.activeId].x = drag.initX + dx;
          state.elements[state.activeId].y = drag.initY + dy;
          updateElementTransform(state.activeId);
        }
      });

      window.addEventListener('mouseup', () => {
        drag.isDragging = false;
      });

      window.addEventListener('touchmove', (e) => {
        if (!drag.isDragging || !state.activeId) return;
        const touch = e.touches && e.touches[0];
        if (!touch) return;
        const dx = touch.clientX - drag.startX;
        const dy = touch.clientY - drag.startY;
        if (state.elements[state.activeId]) {
          state.elements[state.activeId].x = drag.initX + dx;
          state.elements[state.activeId].y = drag.initY + dy;
          updateElementTransform(state.activeId);
        }
        e.preventDefault();
      }, { passive: false });

      window.addEventListener('touchend', () => {
        drag.isDragging = false;
      });

      if (DOM.canvas) {
        DOM.canvas.addEventListener('mousedown', (e) => {
          if (e.button !== 0) return;
          if (e.target.closest('.draggable-item')) return;
          if (e.target.closest('input, textarea, button, select, [contenteditable="true"]')) return;
          canvasPan.isPanning = true;
          canvasPan.startX = e.clientX;
          canvasPan.startY = e.clientY;
          canvasPan.scrollLeft = DOM.canvas.scrollLeft;
          canvasPan.scrollTop = DOM.canvas.scrollTop;
          DOM.canvas.classList.add('is-panning');
        });

        window.addEventListener('mousemove', (e) => {
          if (!canvasPan.isPanning || !DOM.canvas) return;
          const dx = e.clientX - canvasPan.startX;
          const dy = e.clientY - canvasPan.startY;
          DOM.canvas.scrollLeft = canvasPan.scrollLeft - dx;
          DOM.canvas.scrollTop = canvasPan.scrollTop - dy;
        });

        window.addEventListener('mouseup', () => {
          if (!DOM.canvas) return;
          canvasPan.isPanning = false;
          DOM.canvas.classList.remove('is-panning');
        });

        DOM.canvas.addEventListener('touchstart', (e) => {
          if (e.target.closest('.draggable-item')) return;
          if (e.target.closest('input, textarea, button, select, [contenteditable="true"]')) return;
          const touch = e.touches && e.touches[0];
          if (!touch) return;
          canvasPan.isPanning = true;
          canvasPan.startX = touch.clientX;
          canvasPan.startY = touch.clientY;
          canvasPan.scrollLeft = DOM.canvas.scrollLeft;
          canvasPan.scrollTop = DOM.canvas.scrollTop;
          DOM.canvas.classList.add('is-panning');
        }, { passive: true });

        window.addEventListener('touchmove', (e) => {
          if (!canvasPan.isPanning || !DOM.canvas || drag.isDragging) return;
          const touch = e.touches && e.touches[0];
          if (!touch) return;
          const dx = touch.clientX - canvasPan.startX;
          const dy = touch.clientY - canvasPan.startY;
          DOM.canvas.scrollLeft = canvasPan.scrollLeft - dx;
          DOM.canvas.scrollTop = canvasPan.scrollTop - dy;
          e.preventDefault();
        }, { passive: false });

        window.addEventListener('touchend', () => {
          if (!DOM.canvas) return;
          canvasPan.isPanning = false;
          DOM.canvas.classList.remove('is-panning');
        });
      }
    }

    function printDocument() {
      const active = document.activeElement;
      if (active && typeof active.blur === 'function') active.blur();
      selectElement(null);
      window.print();
    }

    return {
      init: function () {
        bindEvents();
        addDraggableElement('circle', { id: 'sealCircle', text1: 'XXXä¸­å¿ƒåŒ»é™¢', text2: 'å¤„æ–¹ä¸“ç”¨ç« ', grunge: 60, rotate: -2, x: 590, y: 350 });
        addDraggableElement('sign', { id: 'dragSign', text1: 'ç‹åŒ»ç”Ÿ', color: '#1a2233', rotate: -5, skew: -25, size: 50, font: "'Liu Jian Mao Cao', cursive", spacing: -8, x: 600, y: 450 });
        refreshAllRandom();
        syncHospitalName('control');
        document.querySelectorAll('#pgFinalRoot .diag-textarea').forEach(el => {
          el.addEventListener('input', resizeTextareas);
        });
        selectElement(null);
        setTimeout(resizeTextareas, 100);
      },
      addRectSeal: function (txt) { addDraggableElement('rect', { text1: txt, grunge: 30, rotate: 2 }); },
      addSignature: function (txt) { addDraggableElement('sign', { text1: txt, rotate: -5, skew: -25, size: 50, font: "'Liu Jian Mao Cao', cursive", spacing: -8, color: '#1a2233' }); },
      updateActiveElement: updateActiveElement,
      deleteActiveElement: deleteActiveElement,
      toggleMode: toggleMode,
      toggleDifang: toggleDifang,
      refreshAllRandom: refreshAllRandom,
      syncHospitalName: syncHospitalName,
      syncContent: syncContent,
      generateAIPrescription: generateAIPrescription,
      printDocument: printDocument,
      updateGlobalSealColor: function () {
        const color = document.getElementById('globalSealColor').value;
        document.querySelectorAll('#pgFinalRoot .draggable-item[data-type="circle"], #pgFinalRoot .draggable-item[data-type="rect"]').forEach(el => {
          el.setAttribute('data-color', color);
          el.style.color = color;
        });
      }
    };
  })();

  window.addEventListener('DOMContentLoaded', () => {
    App.init();
  });
</script>